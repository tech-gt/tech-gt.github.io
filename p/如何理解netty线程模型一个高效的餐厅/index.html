<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="在高并发网络编程领域，Netty无疑是Java生态中的王者。但很多开发者在使用Netty时，往往只知其然而不知其所以然。今天我们就来深入剖析Netty的线程模型，看看它是如何用极少的线程处理海量并发连接的。\n核心概念 一句话概括：Netty 的线程模型是基于主从 Reactor 模式的、高度优化的事件驱动模型。它用极少数的线程，通过非阻塞 I/O 和事件循环，来高效地处理海量的并发连接。\n为了让你更好地理解，我们把它拆分成几个核心概念，并用一个生动的比喻来贯穿解释。\n比喻：一个高效的餐厅 想象一下 Netty 就是一个运营极为高效的餐厅：\nBossGroup (老板/迎宾)：餐厅门口有1个（或几个）迎宾员。他们非常专一，只做一件事：迎接客人（接受新的连接），然后把客人引导给服务员。他们从不点餐或上菜。 WorkerGroup (服务员)：餐厅里有一组服务员。一旦迎宾员把客人带到座位上，这位客人就由一位固定的服务员全程负责。这位服务员会处理这位客人的一切需求：点餐、上菜、倒水、结账（处理读写事件和业务逻辑）。 EventLoop (服务员本身)：每个服务员就是一个 EventLoop，他本质上是一个永不停止的循环。他手里有一个任务清单（Task Queue），不停地检查他负责的所有餐桌（Channels）有没有新的需求（I/O 事件），或者有没有人直接给他派发了任务。 Channel (餐桌)：每一张餐桌就是一个 Channel，代表一个客户端连接。关键点在于：一张餐桌（Channel）从始至终只由一位服务员（EventLoop）负责。 Pipeline (服务流程)：客人（数据）来了之后，服务员（EventLoop）会按照一套标准流程来服务，比如先上开胃菜，再上主菜，最后上甜点。这个流程就是 Pipeline，流程中的每个步骤就是一个 Handler。 Netty 线程模型的核心组件 现在我们把比喻和技术概念对应起来：\n1. EventLoopGroup 和 EventLoop：线程的管理者和执行者 EventLoopGroup：这是一个线程池。在 Netty 服务器中，我们通常会创建两个 EventLoopGroup： BossGroup：如比喻中的“迎宾”，专门负责接收客户端的连接请求。当一个新连接进来时，BossGroup 中的一个 EventLoop (线程) 会处理这个连接请求，创建一个代表该连接的 Channel，然后把它“注册”给 WorkerGroup 中的一个 EventLoop。BossGroup 通常只需要配置1个线程就足够了，因为它做的事情非常简单、快速。 WorkerGroup：如比喻中的“服务员团队”，负责处理所有已建立连接的后续 I/O 操作，比如数据的读取、写入以及执行业务逻辑。WorkerGroup 的线程数通常会设置为 CPU 核心数的 2 倍，这是 Netty 官方推荐的一个经验值。 EventLoop：这是 Netty 线程模型的核心。它本质上是一个单线程的执行器，内部维护着一个事件选择器（Selector）和一个任务队列（Task Queue）。 它在一个无限循环中不断地轮询注册在它上面的所有 Channel 的 I/O 事件（例如数据可读、可写等）。 一旦事件发生，它就负责处理这些事件，调用 ChannelPipeline 中的 Handler。 同时，它也会检查任务队列中是否有待执行的任务，并依次执行。 2. Channel 与 EventLoop 的绑定关系 (线程绑定) 这是 Netty 高效和线程安全的关键。一旦一个 Channel 被创建并注册到一个 EventLoop 上，那么该 Channel 的所有 I/O 操作和事件处理都将由这同一个 EventLoop 线程来完成。\n"><title>如何理解Netty线程模型：一个高效的餐厅</title><link rel=canonical href=https://tech-gt.github.io/p/%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3netty%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%B8%80%E4%B8%AA%E9%AB%98%E6%95%88%E7%9A%84%E9%A4%90%E5%8E%85/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="如何理解Netty线程模型：一个高效的餐厅"><meta property='og:description' content="在高并发网络编程领域，Netty无疑是Java生态中的王者。但很多开发者在使用Netty时，往往只知其然而不知其所以然。今天我们就来深入剖析Netty的线程模型，看看它是如何用极少的线程处理海量并发连接的。\n核心概念 一句话概括：Netty 的线程模型是基于主从 Reactor 模式的、高度优化的事件驱动模型。它用极少数的线程，通过非阻塞 I/O 和事件循环，来高效地处理海量的并发连接。\n为了让你更好地理解，我们把它拆分成几个核心概念，并用一个生动的比喻来贯穿解释。\n比喻：一个高效的餐厅 想象一下 Netty 就是一个运营极为高效的餐厅：\nBossGroup (老板/迎宾)：餐厅门口有1个（或几个）迎宾员。他们非常专一，只做一件事：迎接客人（接受新的连接），然后把客人引导给服务员。他们从不点餐或上菜。 WorkerGroup (服务员)：餐厅里有一组服务员。一旦迎宾员把客人带到座位上，这位客人就由一位固定的服务员全程负责。这位服务员会处理这位客人的一切需求：点餐、上菜、倒水、结账（处理读写事件和业务逻辑）。 EventLoop (服务员本身)：每个服务员就是一个 EventLoop，他本质上是一个永不停止的循环。他手里有一个任务清单（Task Queue），不停地检查他负责的所有餐桌（Channels）有没有新的需求（I/O 事件），或者有没有人直接给他派发了任务。 Channel (餐桌)：每一张餐桌就是一个 Channel，代表一个客户端连接。关键点在于：一张餐桌（Channel）从始至终只由一位服务员（EventLoop）负责。 Pipeline (服务流程)：客人（数据）来了之后，服务员（EventLoop）会按照一套标准流程来服务，比如先上开胃菜，再上主菜，最后上甜点。这个流程就是 Pipeline，流程中的每个步骤就是一个 Handler。 Netty 线程模型的核心组件 现在我们把比喻和技术概念对应起来：\n1. EventLoopGroup 和 EventLoop：线程的管理者和执行者 EventLoopGroup：这是一个线程池。在 Netty 服务器中，我们通常会创建两个 EventLoopGroup： BossGroup：如比喻中的“迎宾”，专门负责接收客户端的连接请求。当一个新连接进来时，BossGroup 中的一个 EventLoop (线程) 会处理这个连接请求，创建一个代表该连接的 Channel，然后把它“注册”给 WorkerGroup 中的一个 EventLoop。BossGroup 通常只需要配置1个线程就足够了，因为它做的事情非常简单、快速。 WorkerGroup：如比喻中的“服务员团队”，负责处理所有已建立连接的后续 I/O 操作，比如数据的读取、写入以及执行业务逻辑。WorkerGroup 的线程数通常会设置为 CPU 核心数的 2 倍，这是 Netty 官方推荐的一个经验值。 EventLoop：这是 Netty 线程模型的核心。它本质上是一个单线程的执行器，内部维护着一个事件选择器（Selector）和一个任务队列（Task Queue）。 它在一个无限循环中不断地轮询注册在它上面的所有 Channel 的 I/O 事件（例如数据可读、可写等）。 一旦事件发生，它就负责处理这些事件，调用 ChannelPipeline 中的 Handler。 同时，它也会检查任务队列中是否有待执行的任务，并依次执行。 2. Channel 与 EventLoop 的绑定关系 (线程绑定) 这是 Netty 高效和线程安全的关键。一旦一个 Channel 被创建并注册到一个 EventLoop 上，那么该 Channel 的所有 I/O 操作和事件处理都将由这同一个 EventLoop 线程来完成。\n"><meta property='og:url' content='https://tech-gt.github.io/p/%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3netty%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%B8%80%E4%B8%AA%E9%AB%98%E6%95%88%E7%9A%84%E9%A4%90%E5%8E%85/'><meta property='og:site_name' content='Glad You Came'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Netty'><meta property='article:tag' content='线程模型'><meta property='article:tag' content='Reactor'><meta property='article:tag' content='NIO'><meta property='article:tag' content='高并发'><meta property='article:published_time' content='2022-11-08T16:45:00+08:00'><meta property='article:modified_time' content='2022-11-08T16:45:00+08:00'><meta name=twitter:title content="如何理解Netty线程模型：一个高效的餐厅"><meta name=twitter:description content="在高并发网络编程领域，Netty无疑是Java生态中的王者。但很多开发者在使用Netty时，往往只知其然而不知其所以然。今天我们就来深入剖析Netty的线程模型，看看它是如何用极少的线程处理海量并发连接的。\n核心概念 一句话概括：Netty 的线程模型是基于主从 Reactor 模式的、高度优化的事件驱动模型。它用极少数的线程，通过非阻塞 I/O 和事件循环，来高效地处理海量的并发连接。\n为了让你更好地理解，我们把它拆分成几个核心概念，并用一个生动的比喻来贯穿解释。\n比喻：一个高效的餐厅 想象一下 Netty 就是一个运营极为高效的餐厅：\nBossGroup (老板/迎宾)：餐厅门口有1个（或几个）迎宾员。他们非常专一，只做一件事：迎接客人（接受新的连接），然后把客人引导给服务员。他们从不点餐或上菜。 WorkerGroup (服务员)：餐厅里有一组服务员。一旦迎宾员把客人带到座位上，这位客人就由一位固定的服务员全程负责。这位服务员会处理这位客人的一切需求：点餐、上菜、倒水、结账（处理读写事件和业务逻辑）。 EventLoop (服务员本身)：每个服务员就是一个 EventLoop，他本质上是一个永不停止的循环。他手里有一个任务清单（Task Queue），不停地检查他负责的所有餐桌（Channels）有没有新的需求（I/O 事件），或者有没有人直接给他派发了任务。 Channel (餐桌)：每一张餐桌就是一个 Channel，代表一个客户端连接。关键点在于：一张餐桌（Channel）从始至终只由一位服务员（EventLoop）负责。 Pipeline (服务流程)：客人（数据）来了之后，服务员（EventLoop）会按照一套标准流程来服务，比如先上开胃菜，再上主菜，最后上甜点。这个流程就是 Pipeline，流程中的每个步骤就是一个 Handler。 Netty 线程模型的核心组件 现在我们把比喻和技术概念对应起来：\n1. EventLoopGroup 和 EventLoop：线程的管理者和执行者 EventLoopGroup：这是一个线程池。在 Netty 服务器中，我们通常会创建两个 EventLoopGroup： BossGroup：如比喻中的“迎宾”，专门负责接收客户端的连接请求。当一个新连接进来时，BossGroup 中的一个 EventLoop (线程) 会处理这个连接请求，创建一个代表该连接的 Channel，然后把它“注册”给 WorkerGroup 中的一个 EventLoop。BossGroup 通常只需要配置1个线程就足够了，因为它做的事情非常简单、快速。 WorkerGroup：如比喻中的“服务员团队”，负责处理所有已建立连接的后续 I/O 操作，比如数据的读取、写入以及执行业务逻辑。WorkerGroup 的线程数通常会设置为 CPU 核心数的 2 倍，这是 Netty 官方推荐的一个经验值。 EventLoop：这是 Netty 线程模型的核心。它本质上是一个单线程的执行器，内部维护着一个事件选择器（Selector）和一个任务队列（Task Queue）。 它在一个无限循环中不断地轮询注册在它上面的所有 Channel 的 I/O 事件（例如数据可读、可写等）。 一旦事件发生，它就负责处理这些事件，调用 ChannelPipeline 中的 Handler。 同时，它也会检查任务队列中是否有待执行的任务，并依次执行。 2. Channel 与 EventLoop 的绑定关系 (线程绑定) 这是 Netty 高效和线程安全的关键。一旦一个 Channel 被创建并注册到一个 EventLoop 上，那么该 Channel 的所有 I/O 操作和事件处理都将由这同一个 EventLoop 线程来完成。\n"><link rel="shortcut icon" href=/favicon.png><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ 
    startOnLoad: true,
    theme: 'default',
    flowchart: {
      useMaxWidth: true,
      htmlLabels: true
    }
  });
</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b574cd48e619b5ee.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>Glad You Came</a></h1><h2 class=site-description>All that counts is here and now.</h2></div></header><ol class=menu-social><li><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#核心概念>核心概念</a><ol><li><a href=#比喻一个高效的餐厅><strong>比喻：一个高效的餐厅</strong></a></li><li><a href=#netty-线程模型的核心组件><strong>Netty 线程模型的核心组件</strong></a><ol><li><a href=#1-eventloopgroup-和-eventloop线程的管理者和执行者><strong>1. EventLoopGroup 和 EventLoop：线程的管理者和执行者</strong></a></li><li><a href=#2-channel-与-eventloop-的绑定关系-线程绑定><strong>2. Channel 与 EventLoop 的绑定关系 (线程绑定)</strong></a></li></ol></li><li><a href=#工作流程图解><strong>工作流程图解</strong></a></li><li><a href=#核心原则绝不阻塞-io-线程><strong>核心原则：绝不阻塞 I/O 线程！</strong></a><ol><li><a href=#如何处理耗时任务><strong>如何处理耗时任务？</strong></a></li></ol></li></ol></li><li><a href=#实际应用场景><strong>实际应用场景</strong></a><ol><li><a href=#1-高并发web服务器>1. 高并发Web服务器</a></li><li><a href=#2-实时消息推送系统>2. 实时消息推送系统</a></li><li><a href=#3-微服务间通信>3. 微服务间通信</a></li></ol></li><li><a href=#最佳实践建议><strong>最佳实践建议</strong></a><ol><li><a href=#1-线程池配置>1. 线程池配置</a></li><li><a href=#2-handler设计原则>2. Handler设计原则</a></li><li><a href=#总结><strong>总结</strong></a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/java/>Java
</a><a href=/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/>网络编程</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3netty%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%B8%80%E4%B8%AA%E9%AB%98%E6%95%88%E7%9A%84%E9%A4%90%E5%8E%85/>如何理解Netty线程模型：一个高效的餐厅</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 08, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p>在高并发网络编程领域，Netty无疑是Java生态中的王者。但很多开发者在使用Netty时，往往只知其然而不知其所以然。今天我们就来深入剖析Netty的线程模型，看看它是如何用极少的线程处理海量并发连接的。</p><h2 id=核心概念>核心概念</h2><p>一句话概括：<strong>Netty 的线程模型是基于主从 Reactor 模式的、高度优化的事件驱动模型。它用极少数的线程，通过非阻塞 I/O 和事件循环，来高效地处理海量的并发连接。</strong></p><p>为了让你更好地理解，我们把它拆分成几个核心概念，并用一个生动的比喻来贯穿解释。</p><h3 id=比喻一个高效的餐厅><strong>比喻：一个高效的餐厅</strong></h3><p>想象一下 Netty 就是一个运营极为高效的餐厅：</p><ul><li><strong>BossGroup (老板/迎宾)</strong>：餐厅门口有1个（或几个）迎宾员。他们非常专一，只做一件事：<strong>迎接客人（接受新的连接）</strong>，然后把客人引导给服务员。他们从不点餐或上菜。</li><li><strong>WorkerGroup (服务员)</strong>：餐厅里有一组服务员。一旦迎宾员把客人带到座位上，这位客人就由<strong>一位固定的服务员</strong>全程负责。这位服务员会处理这位客人的一切需求：<strong>点餐、上菜、倒水、结账（处理读写事件和业务逻辑）</strong>。</li><li><strong>EventLoop (服务员本身)</strong>：每个服务员就是一个 EventLoop，他本质上是一个<strong>永不停止的循环</strong>。他手里有一个任务清单（Task Queue），不停地检查他负责的所有餐桌（Channels）有没有新的需求（I/O 事件），或者有没有人直接给他派发了任务。</li><li><strong>Channel (餐桌)</strong>：每一张餐桌就是一个 Channel，代表一个客户端连接。关键点在于：<strong>一张餐桌（Channel）从始至终只由一位服务员（EventLoop）负责</strong>。</li><li><strong>Pipeline (服务流程)</strong>：客人（数据）来了之后，服务员（EventLoop）会按照一套标准流程来服务，比如先上开胃菜，再上主菜，最后上甜点。这个流程就是 Pipeline，流程中的每个步骤就是一个 Handler。</li></ul><hr><h3 id=netty-线程模型的核心组件><strong>Netty 线程模型的核心组件</strong></h3><p>现在我们把比喻和技术概念对应起来：</p><h4 id=1-eventloopgroup-和-eventloop线程的管理者和执行者><strong>1. EventLoopGroup 和 EventLoop：线程的管理者和执行者</strong></h4><ul><li><strong>EventLoopGroup</strong>：这是一个线程池。在 Netty 服务器中，我们通常会创建两个 EventLoopGroup：<ul><li><strong>BossGroup</strong>：如比喻中的“迎宾”，专门负责接收客户端的连接请求。当一个新连接进来时，BossGroup 中的一个 EventLoop (线程) 会处理这个连接请求，创建一个代表该连接的 Channel，然后把它“注册”给 WorkerGroup 中的一个 EventLoop。BossGroup 通常只需要配置1个线程就足够了，因为它做的事情非常简单、快速。</li><li><strong>WorkerGroup</strong>：如比喻中的“服务员团队”，负责处理所有已建立连接的后续 I/O 操作，比如数据的读取、写入以及执行业务逻辑。WorkerGroup 的线程数通常会设置为 CPU 核心数的 2 倍，这是 Netty 官方推荐的一个经验值。</li></ul></li><li><strong>EventLoop</strong>：这是 Netty 线程模型的核心。它本质上是一个<strong>单线程的执行器</strong>，内部维护着一个<strong>事件选择器（Selector）和一个任务队列（Task Queue）</strong>。<ul><li>它在一个无限循环中不断地轮询注册在它上面的所有 Channel 的 I/O 事件（例如数据可读、可写等）。</li><li>一旦事件发生，它就负责处理这些事件，调用 ChannelPipeline 中的 Handler。</li><li>同时，它也会检查任务队列中是否有待执行的任务，并依次执行。</li></ul></li></ul><h4 id=2-channel-与-eventloop-的绑定关系-线程绑定><strong>2. Channel 与 EventLoop 的绑定关系 (线程绑定)</strong></h4><p>这是 Netty 高效和线程安全的关键。一旦一个 Channel 被创建并注册到一个 EventLoop 上，<strong>那么该 Channel 的所有 I/O 操作和事件处理都将由这同一个 EventLoop 线程来完成</strong>。</p><p>这种设计被称为<strong>线程封闭（Thread Confinement）</strong>。</p><p><strong>这样做的好处是什么？</strong></p><ul><li><strong>无锁化设计</strong>：因为一个 Channel 的所有操作都在同一个线程中执行，所以你不需要在 ChannelHandler 中对状态进行复杂的同步处理（比如加锁），大大简化了并发编程的难度，并提升了性能。</li><li><strong>可预测的执行顺序</strong>：所有事件都由同一个线程按顺序处理，避免了多线程并发执行带来的不确定性。</li></ul><hr><h3 id=工作流程图解><strong>工作流程图解</strong></h3><p>下面是一个典型的 Netty 服务器工作流程：</p><div class=mermaid>sequenceDiagram
participant Client as 客户端
participant Boss as BossGroup
participant Worker as WorkerGroup
participant Pipeline as ChannelPipeline
Note over Boss,Worker: 服务器启动，创建线程组
Client->>Boss: 1. 发起连接请求
Boss->>Boss: 2. 监听ACCEPT事件
Boss->>Worker: 3. 创建SocketChannel并注册到WorkerGroup
loop 数据处理循环
Client->>Worker: 4. 发送数据
Worker->>Pipeline: 5. 触发READ事件
Pipeline->>Pipeline: 6. 数据流经Handler链
Pipeline->>Worker: 7. 处理完成
Worker->>Client: 8. 返回响应
end
Note over Worker: 同一个Channel的所有操作<br>都由同一个EventLoop处理</div><p><strong>详细步骤说明：</strong></p><ol><li><strong>启动与绑定</strong>：服务器启动时，创建 BossGroup 和 WorkerGroup。ServerBootstrap 将 BossGroup 绑定到某个端口上。</li><li><strong>连接接入</strong>：一个客户端发起连接请求。</li><li><strong>BossGroup 处理</strong>：BossGroup 中的一个 EventLoop 线程通过 Selector 监听到这个 ACCEPT 事件。</li><li><strong>创建与注册</strong>：BossGroup 的 EventLoop 接受连接，创建一个新的 SocketChannel（代表与客户端的连接），然后从 WorkerGroup 中选择一个 EventLoop，并将这个 SocketChannel 注册到该 EventLoop 上。</li><li><strong>WorkerGroup 工作</strong>：从此以后，这个 SocketChannel 的所有 READ、WRITE 事件都由这个被选中的 WorkerGroup 的 EventLoop 来全权负责处理。数据会通过该 Channel 的 Pipeline 进行流动和处理。</li></ol><hr><h3 id=核心原则绝不阻塞-io-线程><strong>核心原则：绝不阻塞 I/O 线程！</strong></h3><p>这是使用 Netty 时必须遵守的黄金法则。</p><p>EventLoop 线程（WorkerGroup 中的线程）是非常宝贵的资源，它们需要快速地处理成千上万个连接的 I/O 事件。如果你在 ChannelHandler 中执行了任何耗时的操作，比如：</p><ul><li>长时间的计算</li><li>调用阻塞的数据库 API</li><li>进行阻塞的网络调用（如请求另一个服务）</li></ul><p>那么，这个 EventLoop 线程就会被卡住，无法去处理它负责的其他几千个 Channel 的 I/O 事件，从而导致整个系统的响应延迟，甚至瘫痪。</p><h4 id=如何处理耗时任务><strong>如何处理耗时任务？</strong></h4><p>如果你的业务逻辑中确实有耗时操作，正确的做法是<strong>将这些任务从 I/O 线程中剥离出去</strong>，交给一个专门的业务线程池来处理。</p><p>Netty 提供了 DefaultEventExecutorGroup，你可以用它来创建一个业务线程池。</p><p><strong>代码示例：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>NettyServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1. 创建线程组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventLoopGroup</span><span class=w> </span><span class=n>bossGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>  </span><span class=c1>// 通常1个线程足够</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventLoopGroup</span><span class=w> </span><span class=n>workerGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>();</span><span class=w> </span><span class=c1>// 默认CPU核心数*2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 2. 创建独立的业务线程池，用于处理耗时任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>EventExecutorGroup</span><span class=w> </span><span class=n>businessGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultEventExecutorGroup</span><span class=p>(</span><span class=n>16</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServerBootstrap</span><span class=w> </span><span class=n>bootstrap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerBootstrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bootstrap</span><span class=p>.</span><span class=na>group</span><span class=p>(</span><span class=n>bossGroup</span><span class=p>,</span><span class=w> </span><span class=n>workerGroup</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>channel</span><span class=p>(</span><span class=n>NioServerSocketChannel</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>option</span><span class=p>(</span><span class=n>ChannelOption</span><span class=p>.</span><span class=na>SO_BACKLOG</span><span class=p>,</span><span class=w> </span><span class=n>128</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>childOption</span><span class=p>(</span><span class=n>ChannelOption</span><span class=p>.</span><span class=na>SO_KEEPALIVE</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>childHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>SocketChannel</span><span class=w> </span><span class=n>ch</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ChannelPipeline</span><span class=w> </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ch</span><span class=p>.</span><span class=na>pipeline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// 3. 添加编解码器（在I/O线程中执行，必须快速）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;decoder&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringDecoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=s>&#34;encoder&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringEncoder</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// 4. 添加业务Handler到独立线程池（避免阻塞I/O线程）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=n>businessGroup</span><span class=p>,</span><span class=w> </span><span class=s>&#34;business&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BusinessHandler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 5. 绑定端口并启动服务器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bootstrap</span><span class=p>.</span><span class=na>bind</span><span class=p>(</span><span class=n>port</span><span class=p>).</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Netty服务器启动成功，端口：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 6. 等待服务器关闭</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>future</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>closeFuture</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 7. 优雅关闭所有线程组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bossGroup</span><span class=p>.</span><span class=na>shutdownGracefully</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>workerGroup</span><span class=p>.</span><span class=na>shutdownGracefully</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>businessGroup</span><span class=p>.</span><span class=na>shutdownGracefully</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 业务处理Handler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>BusinessHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ChannelInboundHandlerAdapter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>channelRead</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 这里可以安全地执行耗时操作，因为运行在独立的业务线程池中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>msg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 模拟耗时的业务处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>100</span><span class=p>);</span><span class=w> </span><span class=c1>// 这在I/O线程中是绝对禁止的！</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;处理完成: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>request</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ctx</span><span class=p>.</span><span class=na>writeAndFlush</span><span class=p>(</span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>exceptionCaught</span><span class=p>(</span><span class=n>ChannelHandlerContext</span><span class=w> </span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=n>cause</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cause</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ctx</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>NettyServer</span><span class=p>().</span><span class=na>start</span><span class=p>(</span><span class=n>8080</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=实际应用场景><strong>实际应用场景</strong></h2><h3 id=1-高并发web服务器>1. 高并发Web服务器</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 使用Netty构建HTTP服务器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>NettyHttpServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventLoopGroup</span><span class=w> </span><span class=n>bossGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>EventLoopGroup</span><span class=w> </span><span class=n>workerGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ServerBootstrap</span><span class=w> </span><span class=n>bootstrap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerBootstrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bootstrap</span><span class=p>.</span><span class=na>group</span><span class=p>(</span><span class=n>bossGroup</span><span class=p>,</span><span class=w> </span><span class=n>workerGroup</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>channel</span><span class=p>(</span><span class=n>NioServerSocketChannel</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>childHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ChannelInitializer</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initChannel</span><span class=p>(</span><span class=n>SocketChannel</span><span class=w> </span><span class=n>ch</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ChannelPipeline</span><span class=w> </span><span class=n>pipeline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ch</span><span class=p>.</span><span class=na>pipeline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HttpServerCodec</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HttpObjectAggregator</span><span class=p>(</span><span class=n>65536</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>pipeline</span><span class=p>.</span><span class=na>addLast</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HttpServerHandler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ChannelFuture</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bootstrap</span><span class=p>.</span><span class=na>bind</span><span class=p>(</span><span class=n>port</span><span class=p>).</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>future</span><span class=p>.</span><span class=na>channel</span><span class=p>().</span><span class=na>closeFuture</span><span class=p>().</span><span class=na>sync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bossGroup</span><span class=p>.</span><span class=na>shutdownGracefully</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>workerGroup</span><span class=p>.</span><span class=na>shutdownGracefully</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-实时消息推送系统>2. 实时消息推送系统</h3><p>在实时聊天、游戏服务器等场景中，Netty的线程模型能够：</p><ul><li>维持大量长连接（百万级）</li><li>低延迟消息传递（毫秒级）</li><li>高吞吐量数据处理</li></ul><h3 id=3-微服务间通信>3. 微服务间通信</h3><p>许多RPC框架（如Dubbo、gRPC的Java实现）都基于Netty构建，利用其高效的线程模型实现服务间的高性能通信。</p><h2 id=最佳实践建议><strong>最佳实践建议</strong></h2><h3 id=1-线程池配置>1. 线程池配置</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 推荐的线程池配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>EventLoopGroup</span><span class=w> </span><span class=n>bossGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w> </span><span class=c1>// Boss通常1个线程足够</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>EventLoopGroup</span><span class=w> </span><span class=n>workerGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NioEventLoopGroup</span><span class=p>(</span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>availableProcessors</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 业务线程池大小根据业务特性调整</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>EventExecutorGroup</span><span class=w> </span><span class=n>businessGroup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultEventExecutorGroup</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>16</span><span class=p>,</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>availableProcessors</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>4</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-handler设计原则>2. Handler设计原则</h3><ul><li><strong>编解码Handler</strong>：放在I/O线程中，必须快速执行</li><li><strong>业务逻辑Handler</strong>：放在独立线程池中，可以执行耗时操作</li><li><strong>异常处理</strong>：每个Handler都要正确处理异常，避免影响整个Pipeline</li></ul><h3 id=总结><strong>总结</strong></h3><ul><li><strong>主从 Reactor 模式</strong>：BossGroup (主 Reactor) 负责连接，WorkerGroup (从 Reactors) 负责 I/O 和业务。</li><li><strong>事件驱动</strong>：基于 Selector 的事件通知机制，线程只在有事件发生时才工作。</li><li><strong>线程绑定</strong>：一个 Channel 终生绑定一个 EventLoop 线程，实现了无锁化和高效率。</li><li><strong>黄金法则</strong>：<strong>永远不要阻塞 I/O 线程</strong>，耗时任务请交给独立的业务线程池。</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/netty/>Netty</a>
<a href=/tags/%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/>线程模型</a>
<a href=/tags/reactor/>Reactor</a>
<a href=/tags/nio/>NIO</a>
<a href=/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/>高并发</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/java%E5%BC%82%E5%B8%B8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%BD%BF%E7%94%A8supplier%E5%92%8C%E8%A6%86%E7%9B%96fillinstacktrace%E9%99%8D%E4%BD%8Ecpu%E5%8D%A0%E7%94%A8/><div class=article-details><h2 class=article-title>Java异常性能优化：使用Supplier和覆盖fillInStackTrace降低CPU占用</h2></div></a></article><article><a href=/p/%E4%BB%80%E4%B9%88%E6%98%AF%E5%83%B5%E5%B0%B8%E8%BF%9E%E6%8E%A5%E5%9F%BA%E4%BA%8Enetty%E9%95%BF%E8%BF%9E%E6%8E%A5%E7%BD%91%E5%85%B3%E7%9A%84%E5%AE%9E%E6%88%98%E5%88%86%E6%9E%90/><div class=article-details><h2 class=article-title>什么是僵尸连接？基于Netty长连接网关的实战分析</h2></div></a></article><article><a href=/p/drools%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E5%9C%A8%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/><div class=article-details><h2 class=article-title>Drools规则引擎在业务系统中的实战应用</h2></div></a></article><article><a href=/p/%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8A%A8%E6%80%81%E5%8D%8F%E8%AE%AE%E8%BD%AC%E6%8D%A2%E7%9A%84%E6%8E%A5%E5%8F%A3%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7/><div class=article-details><h2 class=article-title>构建一个动态协议转换的接口调试工具</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 Glad You Came</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>